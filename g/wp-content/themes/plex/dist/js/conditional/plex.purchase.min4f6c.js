!function(e,t){"use strict";var a=!1,i={planData:{},returnPage:"tidal-auth",initEvents:function(){var t=plex_l10n.purchase.tidal.trial_duration;i.setPlanData(),e(".purchase-header").removeClass("active"),e(".ppp-header.purchase-header-tidal").addClass("active"),PlexPurchase.isTransfer("tidal")?(e(".transfer-subsc-hidden").hide(),e(".transfer-subsc-tidal").show()):e(".transfer-subsc-hidden").show(),e(document).on("refreshedPrices",function(e,t){if(Plex.hasLinkedProvider("tidal")){var a=Plex.getLinkedProviderPlan("tidal","subscriptionType");a+=Plex.hasActivePlexPass()?"":"_bundle",PlexPurchase.setSelPlan(a)}}),e(document).on("summaryUpdatedAfter",function(a,r,n){var o=e(".ppp-form-summary"),l=e(".ppp-trial-tidal");if(e(".ppp-header-summary").filter(".ppp-header-icon.header-icon-pp").show(),e(".ppp-header-summary-icon").filter(".ppp-icon, .ppp-icon-tidal").hide(),e(".ppp-header-summary-icon").filter(".ppp-"+r).show(),PlexPurchase.isTransfer("tidal")&&(o.find(".transfer-subsc-tidal").show(),Plex.hasLinkedProvider("tidal"))){var p=Plex.getLinkedProviderPlan("tidal","subscriptionType");e(".transfer-subsc-tidal").find(".transfer-subsc-plan-name").html(p.toUpperCase())}if(!Plex.hasExpiredTrial("tidal")&&!PlexPurchase.isTransfer("tidal")){o.find(".ppp-price-note").show(),l.show(),l.find(".ppp-cc-required").show();var s=void 0!==i.planData[r]?i.planData[r].trial:t,d=s+(1===s?" Day":" Days"),c=moment().add(s,"days");l.find(".ppp-trial-enddate").html(c.format("dddd, MMMM Do YYYY")),l.find(".pp-pdc-price").html(PlexPurchase.formattedPriceWithTax(n,!1)),l.find(".pp-pdc-duration-desc-wrap").html(c.format("MMMM Do, YYYY")),"lifetime"===Plex.getSubscriptionAuthInfo().plan&&(l.find(".sub-text").hide(),l.find(".sub-text-lifetime").show()),e(".ppp-trial-tidal").find(".pp-plan-trial").show(),e(".ppp-trial-tidal").find(".ppp-trial-duration").html(d),o.find(".ppp-trial-tidal").show(),o.find(".ppp-disclosure-duration-trial").show()}e(".ppp-summary").find(".ppp-disclosure").show(),e(".ppp-summary").find(".ppp-disclosure-duration-tidal").show(),o.find(".ppp-purchase-summary").hide(),o.find(".ppp-purchase-bt").hide(),PlexPurchase.isTransfer("tidal")?(o.find(".ppp-tidal-transfer-subsc-bt").show(),o.find(".ppp-tidal-transfer-subsc-summary").show(),o.find(".transfer-subsc-hidden").hide(),o.find(".transfer-subsc-toggable").show(),e(".transfer-subsc-hidden").hide(),e(".transfer-subsc-tidal").show()):(o.find(".ppp-tidal-link-bt").show(),o.find(".ppp-tidal-link-summary").show(),e(".transfer-subsc-hidden").show(),e(".transfer-subsc-tidal").hide())})},isReturnPage:function(){return PlexUtils.getPageForURL()===this.returnPage},isReturningFromTidal:function(){return this.isReturnPage()},setPlanData:function(t){e.each(plex_l10n.plans.tidal,function(e,t){i.planData[t.id]=t})},submitPurchase:function(e,t){if(PlexPurchase.showLoading("tidal"),PlexPurchase.hasPendingSubscription()&&void 0===t._reset&&t.mode===e.plan&&void 0!==t.extraData&&void 0!==t.extraData.redirect_url)return void this.tidalRedirect(t);i.createTidalSubsc(e)},createTidalSubsc:function(t){var a={"X-Plex-Product":"Plex SSO","X-Plex-Client-Identifier":Plex.getClientIdentifier(),"X-Plex-Token":Plex.getAuthToken()};PlexPurchase.isTransfer("tidal")&&(t.transfer=1),t.chosen_mode=t.plan,e.ajax({dataType:"json",type:"POST",headers:a,url:PlexUtils.getAPIUrl()+"/api/v2/subscriptions/tidal",data:t,xhrFields:{withCredentials:!0},crossDomain:!0,success:function(e){if(Plex.debugLog()&&console.log(e),"failed"===e.state)return PlexPurchase.hideLoading(),PlexPurchase.toggleSubscriptionResultPanel("error"),void PlexPurchase.showProcessError(e.extraData.error);PlexMetrics.pushEvent("TidalSubscriptionLinkStart"),i.tidalRedirect(e)},error:function(e){Plex.debugLog()&&console.log(e),PlexPurchase.hideLoading(),PlexPurchase.useActiveSubscPayment()||PlexPurchase.resetNonces(),PlexPurchase.toggleSubscriptionResultPanel("error"),PlexPurchase.showProcessError(e)}})},tidalRedirect:function(e){if(PlexUtils.isDevelopment()){var t=PlexUtils.getCookieDomain();Cookies.set("plex_tv_staging_env",PlexUtils.getCurrentStagingEnv(),{domain:t})}PlexUtils.redirect(e.extraData.redirect_url)},processRedirect:function(e){var a=PlexUtils.getParam("partnerOrderId"),r=PlexUtils.getParam("partnerUserId"),n=PlexUtils.getParam("status"),o=PlexUtils.getParam("partnerProductType"),l=o.replace("_trial","");if(parseInt(r)!==parseInt(Plex.getAuthInfo().id))return void PlexPurchase.showProcessError({status:"Reason",statusText:"User mismatch - please sign-in with the user currently trying to link a Tidal account."},".ppp-form-error-tidal",i.getCheckoutURL());if(n&&"OK"!==n.toUpperCase())return void PlexPurchase.showProcessError(n+".ppp-"+l);var p=function(r,n){var o=(PlexUtils.getParam("orderReference"),t.location.href);if(o=PlexUtils.removeParam("orderReference",o),t.history.replaceState({},"",o),!n||void 0===n.extraData)return void PlexPurchase.showProcessError({status:"Reason",statusText:"Invalid Order ID."},".ppp-form-error-tidal",i.getCheckoutURL());if(PlexPurchase.hideLoading(),PlexMetrics.pushEvent("TidalSubscriptionLinkEnd"),"failed"===n.state)PlexPurchase.showProcessError({status:"Reason",statusText:n.extraData.error},".ppp-form-error-tidal");else{PlexUser.refreshAuthInfo(!0,!0),PlexPurchase.hideLoading(),PlexPurchase.toggleSubscriptionResultPanel("success",n.mode);var l=PlexPurchase.getPlanData(e,"prices",n.mode).toString(),p=PlexPurchase.getPlanData(e,"prices",n.mode,"USDIndex").toString(),s={plan:n.mode,price:l,priceUSD:p,discountedPrice:l,discountedPriceUSD:p,currencyCode:n.extraData.currency,countryCode:n.extraData.country_code,transactionID:a};r.indexOf("trial")>=0?PlexMetrics.pushEvent("TrialSubscriptionTidal","",s):PlexMetrics.pushEvent("SubscriptionTidal","",s);var d={plan:n.mode,metricPlan:r};n.mode.indexOf("hifi_bundle")>=0&&PlexPurchase.trackMetric("purchase:plexpass",d,n.id);var c="trial:tidal";Plex.hasExpiredTrial("tidal")&&(c="purchase:tidal"),PlexPurchase.trackMetric(c,d,n.id)}};Plex.getSubscriptionStatus(a).always(function(e){p(o,e)})},getCheckoutURL:function(t){t=void 0!==t?t:PlexUtils.getParam("partnerProductType");var a=e("<a>"),i=plex_l10n.purchase.purchase_url;return t=t||"premium",a.attr("href",i),t?PlexUtils.appendParamToURLString("plan="+t,a[0]):i},updateSummaryCallout:function(e,t,a,i){var r=".new-user";if(e.hide(),e.find(".callout-toggable").hide(),Plex.hasActivePlexPass()){r=".ppp-user";var n=Plex.getSubscriptionAuthInfo();try{e.find(".ppp-user-billing-cycle .billing-cycle").html(PlexPurchase.getPlanName(n.billing_cycle)),e.find(".ppp-user-plan-price").html(PlexPurchase.getPlanData(t,"formattedPrices",n.plans)),e.find(".ppp-user-plan-price").html(PlexPurchase.getPlanData(t,"formattedPrices",n.plans))}catch(e){console.error(e)}}var o=".not-applicable";PlexPurchase.isTransfer("tidal")&&(o+=", .transfer-subsc-hidden"),e.find(".callout-toggable").filter(r).show(),e.find(o).hide(),e.filter(".callout-tidal").show()}};"undefined"==typeof PlexPurchase?t.PlexPurchase=function(){var r,n={},o=null,l=null,p=null,s=null,d=null,c=null,u={},f=!1,h=null,m=null,P=null,g=!1,v=!1,y="",x=!1,b=!1,C="creditcard",S=null,w=null,_=!1,D=!1,T=!1,k=null,A={},U=0,I=0,M=["monthly","yearly","lifetime"],E=["six_months"],F={regular:M,tidal:Plex.Tidal.getAllPlans()},L={monthly:"Monthly",yearly:"Yearly",lifetime:"Lifetime",six_months:"Six Months"},V=["tidal"];e.each(plex_l10n.plans.tidal,function(e,t){L[t.id]=t.title});var z={monthly:"Monthly",yearly:"Yearly",lifetime:"Lifetime",six_months:"Six Month"},B={US:["amex","paypal","discover","mastercard","visa","maestro","jcb"],BRL:["paypal","mastercard","visa"],USD:["amex","paypal","discover","mastercard","visa","maestro"],AUD:["amex","paypal","mastercard","visa","maestro"],CAD:["amex","paypal","mastercard","visa","maestro"],CHF:["amex","paypal","mastercard","visa","maestro"],EUR:["amex","paypal","discover","mastercard","visa","maestro"],GBP:["amex","paypal","discover","mastercard","visa","maestro"]},R={model:{paymentMethod:"",payload:{},nonce:"",amount:0,email:"",billingAddress:{},additionalInformation:{}},threeDSecure:{enabled:!!plex_l10n.purchase.threedsecure,instance:null,liabilityShifted:!1,liabilityShiftPossible:!1,info:{},create:function(e){braintree.threeDSecure.create({version:2,client:e},function(e,a){if(e)return console.error(e),void n.showProcessError("threedsecure-na",null,t.location.href);R.threeDSecure.instance=a})},verify:function(){var t=e.Deferred(),a=function(e){var t=R.getPayload("creditcard"),a=!0;return R.threeDSecure.liabilityShifted=e.liabilityShifted,R.threeDSecure.liabilityShiftPossible=e.liabilityShiftPossible,e.liabilityShiftPossible&&!e.liabilityShifted&&(a=!1),Plex.debugLog()&&(console.log("isValidThreeDSecure:"),console.log(e),console.log("3DSecure "+(a?"valid!":"invalid! ")),console.log("liabilityShiftPossible: "+e.liabilityShiftPossible),console.log("liabilityShifted: "+e.liabilityShifted)),a&&(t.nonce=e.nonce,Plex.debugLog()&&console.log("Nonce updated to: "+e.nonce),R.setPayload("creditcard",t)),a};return R.model.isValidatingPayment=!0,R.threeDSecure.instance.verifyCard({amount:R.model.amount,nonce:R.model.nonce,bin:R.model.payload.creditcard.details.bin,email:R.model.email,billingAddress:R.model.billingAddress,additionalInformation:R.model.additionalInformation,onLookupComplete:function(e,t){Plex.debugLog()&&(console.log("onLookupComplete:"),console.log(e)),R.threeDSecure.info=e.paymentMethod.threeDSecureInfo,t()}}).then(function(e){void 0!==e&&(a(e)?t.resolve():t.reject(e),R.model.isValidatingPayment=!1)}).catch(function(e){R.model.isValidatingPayment=!1,422===e.details.httpStatus||404===e.details.httpStatus?(Plex.debugLog()&&console.log(e),t.resolve()):(console.error(e),t.reject(e))}),t.fail(function(t){var a={code:-100,message:R.threeDSecure.info.status};void 0!==t.name&&"BraintreeError"===t.name&&(a.code=t.code,void 0!==t.details.originalError.details?a.message=t.details.originalError.details.originalError.error.message:a.message=t.details.originalError.description),e(".verify-toggable-error").show(),n.showProcessError(a.message,".ppp-form-error-verify")}),t.promise()}},setPayload:function(e,t){var a=n.getSelPlanDiscountedPrice();R.model.nonce=t.nonce,R.model.amount=a||n.getPlanData(l,"prices",n.getSelPlan()),R.model.payload[e]=t,P=t},unsetPayload:function(e){R.model.nonce=null,delete R.model.payload[e]},getPayload:function(e){return e=e||R.model.paymentMethod,R.model.payload[e]}};return n.initPlexPurchaseForm=function(a){function r(){n.isTidalCheckout()&&i.initEvents(),i.isReturningFromTidal()?i.processRedirect(l):n.loadClientToken().done(function(){var t="regular";n.useActiveSubscPayment()&&n.loadActivePayment(),n.hasPendingSubscription()&&(t="reset",f=!1,n.setSelPlan(T.mode),n.hasValidPendingSubscriptionPayment()&&(f=T.extraData.nonce,t="resume"),e(".pending-subscription-toggable").show()),n.initBraintree(),n.initPaymentForm(),n.refreshPrices(),n.displayCheckout(t)}).fail(function(e){n.showProcessError("init",null,t.location.href),console.error(e)})}if(void 0!==performance.getEntriesByType("navigation")[0]&&"back_forward"===performance.getEntriesByType("navigation")[0].type)return void location.reload(!0);if(Plex.signInGuard("signup")){if(i.isReturningFromTidal()&&PlexUtils.isDevelopment()){var o=Cookies.get("plex_tv_staging_env")||!1,p="";if(o&&o!==PlexUtils.getCurrentStagingEnv())return p=t.location.href.replace(PlexUtils.getCurrentStagingEnv(),o),void PlexUtils.redirect(p)}PlexUser.getSubscriptions().then(function(){return Plex.checkPendingSubscription("tidal")}).then(n.defineSubscriptionData).then(n.defineValidPlans).then(n.maybeSkipCheckout).then(n.loadPlans).then(n.maybeSkipCheckoutNoPlans).then(n.loadCountries).then(n.initPlanEvents).then(n.initCoreFormEvents).then(r).fail(function(t){if(void 0===t||void 0===t.skip_checkout)n.showProcessError("unauthorized"),console.error(t);else if("invalid_tidal_auth"===t.reason){var a=i.getCheckoutURL();n.showProcessError(t.reason,null,a),setTimeout(function(){PlexUtils.redirect(a)},1e3)}else if("tidal_not_available"===t.reason||"not_available"==t.reason)n.showProcessError(t.reason,null,"/"),setTimeout(function(){PlexUtils.redirect("/")},2e3);else if("add_plex_pass"==t.reason)n.showProcessError(t.reason,null,"/"),setTimeout(function(){PlexUtils.redirect(PlexUtils.getAPIUrl()+"/subscription/unbundle_subscription")},1e3);else{var r=e(".ppp-form-already-sub"),o="."+t.reason;e(".loading").hide().find(".loading-message").hide(),r.find(".already-sub-toggable").hide().filter(o).show(),r.show()}})}},n.model={plan:{name:"",feature:"regular",tax:0},zipCode:"",transfer:!1},n.setModel=function(t){n.model=e.extend(!0,n.model,t)},n.getModel=function(e){return e=e||!1,e&&void 0!==n.model[e]?n.model[e]:n.model},n.getTransfer=function(e){var t=PlexUtils.getParam("transfer");return t&&(V.indexOf(t)<0||t!==e)&&(t=!1),t},n.isTransfer=function(e){return void 0===e?n.getModel("transfer")||!1:n.getModel("transfer")===e},n.getValidCCsforSelectedCountry=function(e){var e=void 0!==e?e:n.getSelectedCountryCode(),t=n.getSelectedCurrency();return"US"===e?B.US:B[t]},n.clearPendingSubscription=function(){n.hasPendingSubscription()&&(f=!1,T._reset=!0)},n.defineSubscriptionData=function(e){D=PlexUser.getSubscriptionsInfo(),void 0!==e&&(T=e)},n.defineValidPlans=function(){var e="",t="";if(n.hasPendingSubscription()?e=T.mode:(e=PlexUtils.getParam("plan"))||(e=PlexUtils.getParam("partnerProductType")),/^\w+$/.test(e)||(e=""),"tidal"===(t=n.findPlanType(e))){var a=Plex.Tidal.validPlans(e);a&&(M=a)}e=e||"",n.setModel({plan:{feature:t.trim(),name:e.trim()},transfer:n.getTransfer(t.trim())})},n.maybeSkipCheckout=function(){var t=e.Deferred(),a=!1;if(i.isReturningFromTidal()){if(PlexUtils.getParam("orderReference")&&PlexUtils.getParam("status"))return t.resolve();a=!0}var r=!!Plex.hasActivePlexPass()&&"plex_pass";if(n.isTidalCheckout()||!r)if(n.isTidalCheckout()&&!PlexFlags.hasAccessToFeature("music"))r="not_available";else{var o=Plex.findActiveSubscriptionType("tidal");r=!!o&&o.mode,!n.isTidalCheckout()&&r&&(r=!Plex.Tidal.isAddOn(Plex.getActiveSubscriptionType("tidal","mode"))&&"add_plex_pass")}return!r&&a&&(r="invalid_tidal_auth"),r?t.reject({skip_checkout:!0,reason:r}):t.resolve()},n.maybeSkipCheckoutNoPlans=function(t){var a=e.Deferred(),i=!1;return i||!n.isTidalCheckout()||Plex.canPurchasePlans("tidal")||(i="tidal_not_available"),i?a.reject({skip_checkout:!0,reason:i}):a.resolve(t)},n.loadClientToken=function(){var t=e.Deferred(),a={},i={"X-Plex-Product":"Plex SSO","X-Plex-Client-Identifier":Plex.getClientIdentifier()};return R.threeDSecure.enabled&&plex_l10n.purchase.threedsecure_country_code&&(a.countryCode=S),Plex.isSignedIn()&&(i["X-Plex-Token"]=Plex.getAuthToken()),e.ajax({dataType:"json",type:"GET",headers:i,url:PlexUtils.getAPIUrl()+"/api/v2/subscriptions/client_token.json",crossDomain:!0,data:a}).done(function(e){c=e.clientToken,t.resolve(e)}).then(null,function(e){t.reject(e)}),t.promise()},n.loadPlans=function(){var t=e.Deferred();if(null!==l)return t.resolve(l);var a={"X-Plex-Product":"Plex SSO","X-Plex-Client-Identifier":Plex.getClientIdentifier()},i={};if("regular"!==n.getModel("plan").feature){i.feature=n.getModel("plan").feature;var r=Plex.altPlans();r&&(i.experiment=r)}return Plex.isSignedIn()&&(a["X-Plex-Token"]=Plex.getAuthToken()),e.ajax({dataType:"json",type:"GET",headers:a,url:PlexUtils.getAPIUrl()+"/api/v2/subscriptions/plans.json?all=true",crossDomain:!0,data:i}).done(function(e){l=e,t.resolve(e)}).then(null,function(e){t.reject(e)}),t.promise()},n.loadCountries=function(t){var a=e.Deferred(),i=function(a){var i=e(".dd-country"),r="",o=!1,p=n.getModel("plan").feature,s=n.getPlansFeatureIndex(),d=function(e,t){return"country"!==e||void 0!==l.prices[t]};e.each(a,function(e,t){if(!d(s,e))return o=!0,!0;r+='<option value="'+e+'">'+t.name+"</option>"}),o&&e(".limited-countries-list").filter(".feature-"+p).show(),Plex.hasExpiredTrial("tidal")||e(".trial-limit").filter(".feature-"+p).show(),i.append(r),S="US",void 0!==a[t.defaultCountry]&&(S=t.defaultCountry),Plex.debugLog()&&PlexUtils.getParam("country_code")&&(S=PlexUtils.getParam("country_code")),i.val(S)};if(null!==o)return i(o),a.resolve(o);var r={"X-Plex-Product":"Plex SSO","X-Plex-Client-Identifier":Plex.getClientIdentifier()};return Plex.isSignedIn()&&(r["X-Plex-Token"]=Plex.getAuthToken()),e.ajax({dataType:"json",type:"GET",headers:r,url:PlexUtils.getAPIUrl()+"/api/v2/subscriptions/countries.json",crossDomain:!0}).done(function(e){o=e,i(o),Plex.debugLog()&&console.log(o),a.resolve(e)}).then(null,function(e){a.reject(e)}),a.promise()},n.loadActivePayment=function(){var t=e.Deferred();return PlexUser.getActivePayment().then(function(a){k=a,e.event.trigger("loadedActivePayment",[a]),t.resolve(k)}).fail(function(){t.resolve()}),t.promise()},n.getActivePaymentService=function(){return void 0!==Plex.getAuthInfo().subscription.paymentService&&Plex.getAuthInfo().subscription.paymentService},n.getActivePaymentMethod=function(){return k},n.getResumingSubscription=function(){var e=PlexUtils.getCache("_plex_tv_subsc_id");return e||!1},n.initPlanEvents=function(){n.discountCodesEnabled()||e(".ppp-code").hide(),e(".ppp-plans :radio").hide().click(function(e){e.stopPropagation()}),e(".ppp-plans .ppp-plan").click(function(){if(e(this).hasClass("no-ppp-promo")){if(!1===confirm("The discount code you've applied doesn't support this plan, are you sure you want to continue?"))return;n.removeCode()}e(this).closest(".ppp-plans").find(".ppp-plan").removeClass("selected"),e(this).addClass("selected").find(":radio").click();var t=e(".ppp-plans.active .selected .ppp-plan-name").val();n.setSelPlan(t,!1),n.refreshSummary(),n.trackCheckout("plan")})},n.initCoreFormEvents=function(){e(document).on("click","#btn_validate_code",n.validateSubmittedCode),e(document).on("click","#ppp-remove-code",n.removeCode),e(document).on("keyup","#discount_code",function(t){e(t.currentTarget).parent().find(".field-error").html("").hide(),e(this).val()?e("#btn_validate_code").addClass("active"):e("#btn_validate_code").removeClass("active")}),e(document).on("click","#btn_purchase",function(){var t=function(){n.setValidForm(!1,"Please check the reCAPTCHA ..."),n.reCaptchaReset(),n.showProcessError("recaptcha-expired")},a=function(t){t&&(b=!0,n.toggleVerify("hide"),n.useActiveSubscPayment()?n.showSummary():e("#cc_form").submit())};n.toggleVerify("show","Validating ..."),n.reCaptchaIsVerified()?a(!0):(n.setValidForm(!1,""),PlexUtils.reCaptcha(plex_l10n.purchase.recaptcha,a,t,".validation-error"))}),e(document).on("click","#btn-cancel-tidal-purchase",function(){return confirm("Cancel purchase?")&&void 0!==T.id&&n.deleteSubscription(T.id).then(function(){PlexUtils.redirect("/")}).fail(function(e){PlexUtils.redirect("/")}),!1}),e(document).on("click",".btn_summary_back",function(){e(this).data("returnUrl")?PlexUtils.redirect(e(this).data("returnUrl")):n.hideSummary()}),e(document).on("loadedActivePayment",function(t,a){Plex.debugLog()&&PlexUtils.getParam("postal_code")&&void 0!==a.zipCode&&a.zipCode&&("none"===PlexUtils.getParam("postal_code")?a.zipCode="":a.zipCode=PlexUtils.getParam("postal_code")),void 0!==a.zipCode&&a.zipCode?(n.setModel({zipCode:a.zipCode}),n.updateSaleTax(a.zipCode),n.requiresZipCode()&&(e(".ppp-callout").find(".ppp-user-postal-code").show(),e(".ppp-user-postal-code").find(".active-postal-code").text(a.zipCode))):a&&n.requiresZipCode()&&e(".fieldset.zip").show()}),e(document).on("planChanged",function(e,t,a){n.updateSaleTax()})},n.findPlanType=function(t){var a="regular";return e.each(F,function(i,r){e.each(r,function(e,r){if(r===t)return a=i,!1})}),a},n.findTransferPlanType=function(e){var t="regular";switch(e){case"tidal":t="tidal"}return t},n.submitPurchasePrepare=function(){var e=n.getNonce(),t=n.getSelPlan(),a={plan:t,countryCode:S,zipCode:n.getModel("zipCode")};n.useActiveSubscPayment()?(a.deviceData="",a.nonce=""):(a.deviceData=u,a.nonce=e),null!==p&&(a.discountCode=p.code);var r=Plex.altPlans();r&&(a.experiment=r),PlexMetrics.hasIterableData()&&(a.campaignId=PlexMetrics.getIterableCampaignId(),a.templateId=PlexMetrics.getIterableTemplateId()),n.isTrial()&&"undefined"!=typeof PlexCJ&&void 0!==PlexCJ.trackingData.SID&&PlexCJ.trackingData.SID&&(a.cjData={sid:PlexCJ.trackingData.SID,aid:PlexCJ.trackingData.AID,pid:PlexCJ.trackingData.PID}),n.isTidalCheckout()?i.submitPurchase(a,T):n.submitPurchase(a)},n.submitPurchase=function(t){var a={"X-Plex-Product":"Plex SSO","X-Plex-Client-Identifier":Plex.getClientIdentifier(),"X-Plex-Token":Plex.getAuthToken()};n.showLoading(),e.ajax({dataType:"json",type:"POST",headers:a,url:PlexUtils.getAPIUrl()+"/api/v2/subscriptions.json",data:t,xhrFields:{withCredentials:!0},crossDomain:!0,success:function(e){PlexUser.refreshAuthInfo(!0,!0),n.hideLoading(),n.toggleSubscriptionResultPanel("success");var a={plan:t.plan,price:n.getSelPlanPrice(),priceUSD:n.getPlanPrice(t.plan,"USDIndex").toString(),discountedPrice:n.getSelPlanDiscountedPrice(),discountedPriceUSD:n.getPlanDiscountedPrice(t.plan,"USDIndex").toString(),currencyCode:n.getSelectedCurrency(),countryCode:t.countryCode,transactionID:e.paymentNotificationId,coupon:n.getActiveDiscountCode()};n.isFree()?PlexMetrics.pushEvent("FreeSubscription","",a):n.isTrial()?PlexMetrics.pushEvent("TrialSubscription","",a):PlexMetrics.pushEvent("PaidSubscription","",a),n.trackMetric("purchase:plexpass",t,e.paymentNotificationId)},error:function(e){Plex.debugLog()&&console.log(e),n.hideLoading(),n.toggleSubscriptionResultPanel("error"),n.showProcessError(e),n.useActiveSubscPayment()||n.resetNonces()}})},n.deleteSubscription=function(t){var a=e.Deferred();if(!Plex.isSignedIn())return a.reject("doint it wrong!");var i={"X-Plex-Product":"Plex SSO","X-Plex-Client-Identifier":Plex.getClientIdentifier(),"X-Plex-Token":Plex.getAuthToken()};return e.ajax({dataType:"json",type:"DELETE",headers:i,url:PlexUtils.getAPIUrl()+"/api/v2/subscriptions/"+t,crossDomain:!0,xhrFields:{withCredentials:!0}}).done(function(e){a.resolve(e)}).then(null,function(e){a.reject(e)}),a.promise()},n.reCaptchaIsVerified=function(){return!plex_l10n.purchase.recaptcha.enabled||b||"creditcard"!==C||n.useActiveSubscPayment()},n.reCaptchaReset=function(){plex_l10n.purchase.recaptcha.enabled&&(b=!1,PlexUtils.reCaptchaReset())},n.trackMetric=function(e,t,a){var i=l,r=0,o=t.plan,s={marketplace:"Marketing Website",currency:n.getSelectedCurrency(),amount:n.getPlanData(i,"prices",o).toString(),usdAmount:n.getPlanData(i,"prices",o,"USDIndex").toString(),formattedPrice:n.getPlanData(i,"formattedPrices",o),plan:void 0!==t.metricPlan?t.metricPlan:o};if(null!==p){i=p;var d=n.getPlanData(p,"discountValue",o);void 0!==d&&parseInt(d)>0&&(r=d),s.value=i.code,s.discount=r,s.duration=n.getPlanData(i,"duration",o),s.trial=n.isTrial()?1:0}if(PlexMetrics.track("view",e,{properties:s}),"undefined"!=typeof PlexCJ){var c=s;c.hasDiscount=0,null!==p&&(c.hasDiscount=1,c.fullPrice=n.getPlanData(p,"full",o)),PlexCJ.trackSubscription(c,a)}},n.getActiveDiscountCode=function(){return null!==p?e("#discount_code").val():""},n.removeCode=function(){p=null,d=null,e(".ppp-discount-success").hide(),e(".ppp-discount-error").hide(),e("#discount_code").val("").parent().find(".field-error").hide(),e("#btn_validate_code").show().removeClass("active"),e(".ppp-code .input-field").show(),n.updateSaleTax(),n.refreshPrices(),e(".ppp-plans.active").fadeIn()},n.refreshValidCardTypes=function(){var t=n.getValidCCsforSelectedCountry(),a=e(".cc-icons");a.find(".cc-icon").removeClass("valid").show();for(var i=t.length-1;i>=0;i--)a.find(".cc-icon."+t[i]).addClass("valid");a.find(".cc-icon").not(".valid").hide()},n.refreshPrices=function(){var t=n.getSelectedCountryCode(),a={},i=l,r=n.getSelectedCurrency(),o=n.isTrial(),c=!1;if(_=!1,e(".ppp-plans").removeClass("active"),e(".ppp-plans:not(.exclusive)").addClass("active"),e(".ppp-plans.exclusive").hide(),e(".ppp-plans.exclusive .ppp-plan").hide(),e(".confirmation-default").show(),e(".pp-plan-price > .pp-plan-desc").hide(),e(".pp-plan-price > .pp-plan-desc-default").show(),e(".ppp-plans .ppp-plan").removeClass("no-ppp-promo"),e(".ppp-discount-success [class*=ppp-discount]:not(.ppp-discount-code)").hide(),e(".ppp-trial").hide(),e(".ppp-plans").filter(".active").find(".ppp-plan").removeClass("valid-plan"),t&&""!==t||(t="US"),null!==p&&(i=p),a=n.getPlanData(i,"formattedPrices","all_plans"),e.each(a,function(e,t){"object"!=typeof t&&(a[e]=a[e].replace(r,"").trim())}),null!==p&&void 0!==i.porcentage&&(c=n.formatPercentage(n.getPlanData(i,"porcentage","lifetime")),n.refreshDiscounts(p,i)),null!==p&&void 0!==i.valid){var u=n.getModel("plan").name,f=n.getPlanData(i,"valid",u);f&&(f=u),"lifetime"===f&&o&&(f=!1);var h=n.getPlanData(i,"valid","all_plans");e.each(h,function(t,a){var i=e(".ppp-plan.ppp-"+t);a&&o&&"lifetime"===t&&(a=!1),a?f||(f=t):i.addClass("no-ppp-promo"),a&&o&&"lifetime"!==t&&(e(".pp-plan-trial",i).show(),e(".pp-plan-desc-default",i).hide(),e(".ppp-trial").find(".pp-plan-trial").show())}),e(".ppp-plan .ppp-"+f).hasClass("selected")||(e(".ppp-plans .ppp-plan").removeClass("selected"),e(".ppp-plans").filter(".active").find(".ppp-plan").filter(".ppp-"+f).addClass("selected")),e(".bb-promo").clone().addClass("cloned").prependTo(".ppp-plans.exclusive .ppp-plan.selected").show(),!1!==c&&(e(".bb-promo.cloned").find(".bb-promo-regular").hide(),e(".bb-promo.cloned").find(".bb-promo-lifetime").show()),e.each(M,function(t,r){var o=n.getPlanData(l,"formattedPrices",r);void 0!==i.porcentage&&1!=n.getPlanData(i,"porcentage",r)&&(o=n.formattedFreePrice(n.getPlanData(i,"full",r),a[r])),e(".ppp-plans").filter(".active").find(".ppp-price-"+r+" .price").html(o),e(".ppp-plans").filter(".active:not(.exclusive)").find(".ppp-plan:not(.exclusive).ppp-"+r).addClass("valid-plan").show()})}else e.each(M,function(t,r){var o=n.getPlanData(i,"prices",r);void 0!==o&&(e(".ppp-plans").filter(".active").find(".ppp-price-"+r+" .price").html(n.formattedFreePrice(o,a[r])),e(".ppp-plans").filter(".active:not(.exclusive)").find(".ppp-plan:not(.exclusive).ppp-"+r).addClass("valid-plan").show())}),n.setSelPlan();e(".ppp-plan:not(.ppp-no-currency) .pp-plan-price .currencycode").html(r),o?(n.maybeSetTrialData(),e(".ppp-discount-trial").show(),e(".ppp-trial").show(),e(".ppp-cc-required").show(),d.skip_cc&&e(".ppp-cc-required").hide(),e(".ppp-callout-deets .ppp-trial-duration").html(s.formattedDuration),e(".pp-plan-trial-duration").html(s.formattedDuration).show()):e(".ppp-discount-pricing").show(),e.event.trigger({type:"refreshedPrices",data:i}),n.refreshSummary()},n.refreshDiscounts=function(t,a){Plex.debugLog()&&console.log(t);var i=n.formatPercentage(n.getPlanData(a,"porcentage","monthly")),r=n.formatPercentage(n.getPlanData(a,"porcentage","yearly")),o=n.formatPercentage(n.getPlanData(a,"porcentage","six_months")),p=n.formatPercentage(n.getPlanData(a,"porcentage","lifetime")),s=null,d={monthly:{singular:"month",cycle:"monthly",fomatCycle:"months",format:"Do of MMMM",data:i},yearly:{singular:"year",cycle:"years",fomatCycle:"years",format:"Do of MMMM, YYYY",data:r}};if(e.each(d,function(a,i){if(!1!==i.data){e(".ppp-price-"+a+" .pp-plan-desc").hide(),e(".ppp-price-"+a+" .pp-plan-oldprice").html(n.getPlanData(l,"formattedPrices",a));var r=n.getPlanData(t,"duration",a);"all"!==r&&(s=moment().add(r,i.formaCycle).format(i.format),e(".promo-cycle-"+a+" .pp-pdc-duration").html(r),e(".promo-cycle-"+a+" .pp-pdc-duration-desc-pl").html(i.singular+(r>1?"s":"")),e(".promo-cycle-"+a).show()),e(".ppp-price-"+a+" .pp-plan-off").html(i.data),e(".ppp-price-"+a+" .promo").show()}}),!1!==o){M=M.concat(E),e(".ppp-price-six_months .pp-plan-off").html(o),e(".ppp-price-six_months .pp-plan-desc").hide();var c=n.getPlanData(t,"duration","six_months");"all"!==c&&(s=moment().add(6*c,"months").format("Do of MMMM, YYYY"),e(".promo-cycle-six_months .pp-pdc-duration").html(6*c),e(".promo-cycle-six_months .pp-pdc-duration-desc-pl").html("months"),e(".promo-cycle-six_months").show()),e(".ppp-price-six_months .pp-plan-off").html(o),e(".ppp-price-six_months .promo").show()}if(!1!==p&&(e(".ppp-price-lifetime .pp-plan-oldprice").html(n.getPlanData(l,"formattedPrices","lifetime")),e(".ppp-price-lifetime .pp-plan-off").html(p),e(".ppp-price-lifetime .pp-plan-desc").hide(),e(".ppp-price-lifetime .promo").show()),!p&&s?(e(".ppp-code-cycle").show(),e(".ppp-code-cycle-start").html(s)):e(".ppp-code-cycle").hide(),n.isTrial()&&e(".ppp-plans").filter(".active").find(".promo").hide(),e(".bb-promo.cloned").remove(),t.code.indexOf("PLEX1PP")>=0){var u=t.code.substr(5,3).toLowerCase(),f=e(".ppp-plans.exclusive ."+u),h="six_months";switch(u){case"pp1":h="monthly";break;case"ppy":h="yearly";break;case"ppl":h="lifetime"}_=!0,w="Best Buy",e(".ppp-plans").removeClass("active").hide(),e(".ppp-plans.exclusive").show(),e(".ppp-plans.exclusive").addClass("active"),e(".ppp-plans.exclusive").find(".ppp-plan").addClass("valid-plan"),n.setSelPlan(h),f.show(),e(".bb-promo .partner").text(w),e(".confirmation-default").hide(),e(".confirmation-exclusive-promos").show()}},n.formatPercentage=function(e){return 0!==e&&Math.floor(100*e)+"%"},n.getSelectedCountryCode=function(){return S||"US"},n.getSelectedCurrency=function(){var e=n.getSelectedCountryCode();return"country"===n.getPlansFeatureIndex()?void 0===l.prices[e]?"USD":l.prices[e].meta.currency:void 0!==o[e]?o[e].currency:"USD"},n.getPlansFeatureIndex=function(e){var t=n.getModel("plan").feature;return e=void 0!==e?e:t,Plex.getPlansFeatureIndex(e)},n.getPlansActiveIndex=function(){return"country"===n.getPlansFeatureIndex()?"USD"!==n.getSelectedCurrency()?n.getSelectedCountryCode():"US":n.getSelectedCurrency()},n.getPlanData=function(e,t,a,i){var r=n.getPlansActiveIndex();return a=void 0!==a?a:n.getSelPlan(),void 0!==i&&i&&(r=Plex.getUSDPlansIndex(n.getPlansFeatureIndex())),"all_plans"===a?e[t][r]:e[t][r][a]},n.refreshSummary=function(){var t=n.getSelPlan(),a=l,r=n.getPlanData(l,"formattedPrices"),o=e(".ppp-summary"),d=o.find(".ppp-payment-method-container .cc-icon"),c=e(".ppp-form-summary"),u=e(".ppp-callout"),f=e(".ppp-trial"),h=u.find(".plan-lifetime-disclaimer"),m=o.find(".ppp-payment-details"),g=o.find(".ppp-method-type");if(c.find(".ppp-price-note").hide(),u.find(".ppp-price-note").hide(),d.hide(),h.hide(),null!==p&&(a=p),e(".ppp-form .ppp-no-payment").hide(),n.skipPayment()?(e(".ppp-form .ppp-with-payment").hide(),"lifetime"===t?(e(".ppp-form .ppp-no-payment.lifetime").hide(),_?e(".ppp-form .ppp-no-payment.lifetime.exclusive").show():e(".ppp-form .ppp-no-payment.lifetime.regular").show()):e(".ppp-form .ppp-no-payment.other").show()):e(".ppp-form .ppp-with-payment").show(),n.refreshContinueButton(),g.html(""),"paypal"===C)g.html("PAYPAL");else if("applepay"===C)g.html("APPLE PAY");else if(null!==P)g.html(P.details.cardType.toUpperCase()+" - XX"+P.details.lastTwo);else{var v=function(e){if(void 0!==e){if(u.find(".ppp-payment-method-container .cc-icon-title").show(),e){var t=u.find(".ppp-payment-method-container .cc-icon"),a="paypal";"creditCard"===e.type?(g.html(e.cardType.toUpperCase()+" - XX"+e.lastFourDigits),a="American Express"===e.cardType?"amex":e.cardType):g.html("PAYPAL<br/><small>"+e.email+"</small>"),t.hide().filter("."+a.toLowerCase()).show()}else u.find(".ppp-payment-method-container .cc-icon-na").fadeIn(),g.html("Not Available")}};null!==n.getActivePaymentMethod()?v(n.getActivePaymentMethod()):e(document).on("loadedActivePayment",function(e,t){v(t)})}var y=d.filter(".cc-icon-off").length;if((P||y||e(".tabs-title.paypal").hasClass("is-active")||e(".tabs-title.applepay").hasClass("is-active"))&&!n.skipPayment()){var x=e(".ppp-payment-method-container .cc-icon-title");e(".tabs-title.paypal").hasClass("is-active")?d.filter(".paypal").show():e(".tabs-title.applepay").hasClass("is-active")?d.filter(".applepay").show():y&&d.filter(":not(.cc-icon-off)").show(),x.show()}var b=e(".ppp-selected-plan-price").text(),S=""
;n.isTidalCheckout()&&i.updateSummaryCallout(u,l,L,n.getActivePaymentMethod()),u.find(".ppp-selected-plan-name").html(n.getPlanName(t)),e(".bb-promo-deets-panel .ppp-selected-plan-name.singular-name").html(n.getPlanName(t,!0)),e(".bb-promo .ppp-selected-plan-price").html(r),"lifetime"===t?u.find(".ppp-selected-plan-price").html(n.formattedFreePrice(r)):null!==p&&1!=n.getPlanData(p,"porcentage")?u.find(".ppp-selected-plan-price").html(n.formattedFreePrice()):u.find(".ppp-selected-plan-price").html(r),S=e(".ppp-selected-plan-price").text(),o.find(".panel-plan .pp-plan-title").html(n.getPlanName(t)),o.find(".pp-current-price").html(n.formattedFreePrice(r));var w=null!==p?p:l;if(o.find(".total-price").find(".pp-current-price").html(n.formattedPriceWithTax(w,null!==p)),u.find(".total-price").find(".pp-current-price").html(n.formattedPriceWithTax(w,null!==p)),o.find(".ppp-disclosure-duration").hide().filter(".ppp-disclosure-duration-"+t).show(),e(".ppp-disclosure-duration-"+t+"-placeholder").length&&e(".ppp-disclosure-duration-"+t+"-placeholder").html(n.getPlanName(t)),o.find(".ppp-disclosure .ppp-disclosure-duration").hide(),o.find(".ppp-disclosure-duration-trial").hide(),n.isFree()&&!n.isLimitedFreePlan(t,p)||n.skipPayment()||(o.find(".ppp-disclosure-duration").filter(".ppp-disclosure-duration-"+t).show(),(n.isTrial()||n.isLimitedFreePlan(t,p))&&o.find(".ppp-disclosure-duration-"+t+" .ppp-disclosure-duration-trial").show()),m.show(),f.hide(),n.refreshSummaryDiscounts(p,a),c.find(".ppp-purchase-summary").show(),c.find(".ppp-purchase-bt").show(),c.find(".ppp-non-def-summary").hide(),c.find(".ppp-non-def-bt").hide(),"lifetime"===t&&h.show(),e.event.trigger({type:"summaryUpdated"}),n.isTrial()){n.maybeSetTrialData();var D=moment().add(s.duration,"days"),T=e(".ppp-trial-details.ppp-trial-regular");f.show().find(".ppp-trial-duration").html(s.formattedDuration),f.find(".ppp-trial-enddate").html(D.format("dddd, MMMM Do YYYY")),c.find(".ppp-purchase-bt").hide(),c.find(".ppp-purchase-summary").hide(),c.find(".ppp-trial-bt").show(),c.find(".ppp-trial-summary").show(),T.hide(),e(".ppp-trial-alt").hide(),n.isFree()?(T.find(".pp-pdc-discount-price").html(n.formattedPriceWithTax(p,!0)),T.find(".pp-pdc-price").html(n.formattedPriceWithTax(l,!1)),T.find(".pp-pdc-duration-desc").html("yearly"===t?"year":"month"),T.find(".pp-pdc-duration-desc-wrap").html(D.format("MMMM Do, YYYY")),T.show()):e(".ppp-trial-alt").show(),e.event.trigger({type:"trialSelected"})}n.skipPayment()?(m.hide(),d.filter(".ppp-payment-method-container .cc-icon").hide(),e(".ppp-payment-method-container .cc-icon-title").hide(),"lifetime"===t&&(c.find(".ppp-purchase-bt").hide(),c.find(".ppp-purchase-summary").hide(),c.find(".ppp-free-lifetime-summary").show(),c.find(".ppp-free-lifetime-bt").show()),e.event.trigger({type:"skipPayment"})):b!==S&&e.event.trigger({type:"priceChange"}),e.event.trigger("summaryUpdatedAfter",[t,a])},n.refreshSummaryDiscounts=function(t,a){var i=e(".ppp-summary"),r=e(".ppp-callout"),o=i.find(".promo"),p=i.find(".ppp-discount"),s=e(".promo-duration-cycle");if(o.hide(),p.hide(),s.hide(),null!==t&&void 0!==a.porcentage){var d=n.getSelPlan(),c=n.formatPercentage(n.getPlanData(a,"porcentage")),u=n.getPlanData(l,"formattedPrices");if(!1!==c){if(p.show(),p.find(".code").html(t.code),p.find(".discount").html(c),i.find(".pp-small-price .pp-current-price").html(u),o.find(".plan-off").html(c),o.find(".plan-oldprice").html(u),!n.isTrial()&&"all"!==n.getPlanData(t,"duration")&&"lifetime"!==d){var f=n.getPlanData(t,"duration"),h="each ",m="",P="thereafter",g="";"six_months"===d?(f*=6,h="every 6 months",m="months",g=", YYYY"):(h+="yearly"===d?"year":"month",m=("monthly"===d?"month":"year")+(f>1?"s":"")),P="yearly"===d?"from the "+moment().add(n.getPlanData(t,"duration","yearly"),"years").format("Do of MMMM, YYYY"):"from the "+moment().add(f,"months").format("Do of MMMM"+g),s.find(".pp-pdc-discount-price").html(n.formattedPriceWithTax(t,!0)),s.find(".pp-pdc-duration").html(f),s.find(".pp-pdc-duration-desc-wrap").html(P),s.find(".pp-pdc-duration-desc-pl").html(m),e(".pp-pdc-duration-desc").html(h),e(".bb-promo").find(".pp-pdc-price").html(n.formattedPriceWithTax(l,!1)),s.find(".pp-pdc-price").html(n.formattedPriceWithTax(l,!1)),i.find(".ppp-price-note").show(),r.find(".ppp-price-note").show(),s.show()}o.show()}}},n.showSummary=function(t){t=void 0===t||t,n.refreshSummary(),e(".ppp-form").hide(),e(".ppp-plans").removeClass("hidden"),e(".ppp-plans.exclusive").is(":visible")?e(".ppp-plans:not(.exclusive)").addClass("hidden"):e(".ppp-plans.exclusive").addClass("hidden"),e(".ppp-plans").hide(),e(".ppp-header").hide(),e(".ppp-form-summary").show(),e(".ppp-header.ppp-header-summary").show(),e(".sign-frame").addClass("frame-summary"),e(".summary-back-toggable").hide(),t?e(".summary-back-toggable").filter(".btn-continue-checkout").show():e(".summary-back-toggable").filter(".btn-restart-checkout").show(),n.useActiveSubscPayment()&&e(".ppp-purchase-action").show(),n.isTransfer()&&e(".transfer-subsc").filter("."+n.getModel("transfer")).hide(),n.trackCheckout("summary")},n.hideSummary=function(){e(".form-error").hide(),e(".alt-summary").hide(),e(".ppp-form-summary").hide(),e(".ppp-header.ppp-header-summary").hide(),e(".sign-frame").removeClass("frame-summary"),e(".ppp-header.active").show(),e(".ppp-form").show(),e(".ppp-plans:not(.hidden)").show(),n.togglePaymentForm()},n.togglePaymentForm=function(t){t=void 0===t||t;var a=e(".ppp-form-container"),i="payment-form",r="";n.useActiveSubscPayment()&&(i="payment-form-pp",r=n.isTransfer()?".transfer-subsc":".regular-subsc",Plex.hasActivePlexPass()?r+="-pp":r+="-other"),n.isTransfer()&&(e(".purchase-header-"+n.getModel("transfer")).find(".purchase-header-toggable").hide(),e(".purchase-header-"+n.getModel("transfer")).find(".transfer-subsc-"+n.getModel("transfer")).fadeIn()),a.find(".payment-form-toggable").hide(),e(".sub-purchase").addClass(i),i="."+i+r,n.hasPendingSubscription()&&e(".transfer-subsc-hidden").hide(),a.find(".payment-form-toggable").filter(i).toggle(t),a.show()},n.displayCheckout=function(t){var a=PlexUtils.getParam("code");if(n.hideLoading(),e(".ppp-header.active").show(),e(".ppp-form").show(),n.refreshValidCardTypes(),"regular"!==t){var i=!0;return Plex.hasActivePlexPass()||(i=!1),n.hideLoading(),"resume"===t?n.showProcessError("resumable-order"):n.showProcessError("non-resumable-order"),void n.showSummary(i)}void 0!==a&&null!==a&&n.discountCodesEnabled()?n.validateCode(a):e(".ppp-plans.active").fadeIn(),n.togglePaymentForm(),n.refreshContinueButton()},n.initPaymentForm=function(){var t=e(".ppp-payment-method-container .cc-icon-title");n.zipCodeValidityChange(".postalCode.billing-field"),e(document).on("change.zf.tabs","#purchase",function(a,i){var r=e(".ppp-payment-method-container .cc-icon");if(r.hide(),e(".ppp-purchase-action").hide(),C=e(i).data("payment"),PlexUtils.toggleReCaptcha("show"),"paypal"===C)n.toggleVerify("hide"),r.hide().filter(".paypal").show(),e("#paypal_country_form").find(".pp-country").trigger("change"),e("#paypal-postal-code").trigger("keyup",!0);else if("applepay"===C)r.hide().filter(".applepay").show();else{var o=r.filter(".cc-icon-off").length;r=r.hide().filter(":not(.cc-icon-off)"),t.hide(),o&&(r.show(),t.show()),e("#cc_form").find(".cc-country").trigger("change"),e("#card-number input[name=credit-card-number]").change(),e("#creditcard-postal-code").trigger("keyup",!0)}e(".ppp-callout .ppp-disclosure-paymentmethod").hide().filter(".ppp-disclosure-paymentmethod-"+C).show(),"creditcard"!==C&&e(".ppp-payment-method-container .cc-icon-title").show(),n.refreshContinueButton()})},n.validateSubmittedCode=function(){var t=e("#discount_code").val();n.validateCode(t)},n.validateCode=function(t){var a={"X-Plex-Product":"Plex SSO","X-Plex-Client-Identifier":Plex.getClientIdentifier()},i=null,r=e(".ppp-code .validating-promo");if(0===t.trim().length)return i=e(".empty-promo-code-text").text(),void e("#discount_code").parent().find(".field-error").html(i).show();e("#btn_validate_code").hide(),e(".ppp-discount-success").hide().find(".ppp-discount-code").html(""),e(".ppp-discount-error").hide(),e("#discount_code").parent().find(".field-error").hide(),e(".ppp-code .input-field").hide(),r.show(),Plex.isSignedIn()&&(a["X-Plex-Token"]=Plex.getAuthToken());var o=t.toUpperCase().trim();e.ajax({dataType:"json",type:"GET",headers:a,data:{token:o},url:PlexUtils.getAPIUrl()+"/api/v2/subscriptions/code/validate.json",crossDomain:!0,success:function(t){Plex.debugLog()&&console.log(t);var a=t.discounts;d=t.options,p={code:o,prices:{},formattedPrices:{},full:{},porcentage:{},duration:{},valid:{},discountValue:{}},e.each(a,function(t,a){p.prices[t]={},p.formattedPrices[t]={},p.full[t]={},p.porcentage[t]={},p.duration[t]={},p.valid[t]={},p.discountValue[t]={},e.each(a,function(e,a){p.valid[t][e]=a.valid,a.valid?(p.prices[t][e]=a.price,p.formattedPrices[t][e]=a.formattedPrice,p.full[t][e]=a.fullPrice,p.porcentage[t][e]=a.discount,p.duration[t][e]=a.duration,p.discountValue[t][e]=a.discountValue):(p.prices[t][e]=l.prices[t][e],p.formattedPrices[t][e]=l.formattedPrices[t][e],p.full[t][e]=l.prices[t][e],p.porcentage[t][e]=0)})}),r.hide(),e(".ppp-discount-success").show(),e(".ppp-discount-code").text(o),e(".ppp-code .input-field").hide(),n.trackCheckout("applied_valid_code")},error:function(t){r.hide(),e("#btn_validate_code").show(),e(".ppp-code .input-field").show(),p=null,i="Couldn't validate the discount code. Please try again later.",i=422===t.status||1069===t.status?e(".invalid-promo-code-text").text():409===t.status?e(".used-promo-code-text").text():e(".error-promo-code-text").text(),e("#discount_code").parent().find(".field-error").html(i).show(),n.trackCheckout("applied_invalid_code")},complete:function(){e(".ppp-plans.active").fadeIn(),n.refreshPrices(),n.setSelPlan(),n.updateSaleTax()}})},n.updateSaleTax=function(e,t,a,i){var i=i||!1,r=n.getModel("plan").name,o=null===p||i?"none":p.code;if(e=e||n.getModel("zipCode"),null===p&&n.setModel({plan:{tax:0,discountTax:0}}),e.length>=3&&"US"===S){if(U===e+o&&I===r)return;"none"===o||i||n.updateSaleTax(e,t,a,!0),U=e+o,I=r;var l=function(){U=0,I="",n.toggleValidation(),n.refreshContinueButton(),void 0!==a&&a()};if(void 0!==A[e]&&void 0!==A[e][r]&&void 0!==A[e][r][o]){var s=A[e][r][o];return"none"!==o?n.setModel({plan:{discountTax:s.amount,discountTaxFormatted:s.formattedAmount}}):n.setModel({plan:{tax:s.amount,taxFormatted:s.formattedAmount}}),n.toggleSaleTaxDetails(!0),x=!0,void l()}n.toggleValidation("show","Validating ..."),n.getSaleTaxForZip(e,r,o).then(function(a){"none"!==o?n.setModel({plan:{discountTax:a.amount,discountTaxFormatted:a.formattedAmount}}):n.setModel({plan:{tax:a.amount,taxFormatted:a.formattedAmount}}),n.toggleSaleTaxDetails(!0),void 0!==t&&n.toggleFieldError(t,!1),x=!0,void 0===A[e]&&(A[e]={}),void 0===A[e][r]&&(A[e][r]={}),A[e][r][o]=a}).fail(function(a){n.getModel("zipCode")===e&&(Plex.debugLog()&&console.error(a),x=!1,n.toggleFieldError(t,!0))}).always(function(){l()})}else n.setModel({plan:{tax:0,discountTax:0}}),e.length>=3&&(x=!0,n.refreshContinueButton())},n.requiresZipCode=function(){return"US"===S&&!n.skipPayment()},n.isValidZipCode=function(){var e=n.getModel("zipCode"),t=!1;return e.length>=3&&x&&(t=!0),t},n.zipCodeValidityChange=function(t,a){var i=!1,o=1e3;e(document).on("keydown",t,function(e){clearTimeout(r)}),e(document).on("keyup",t,function(l,p){var s=e(this).val().trim();p&&(o=0),clearTimeout(r),n.toggleFieldError(t,!1),e(".postalCode").val(s),n.toggleSaleTaxDetails(!1),n.refreshContinueButton(!1),s!==n.getModel("zipCode")&&(n.setModel({plan:{tax:0,discountTax:0}}),n.setModel({zipCode:s})),s.length>=3&&"US"===S?(i=!0,r=setTimeout(function(){n.updateSaleTax(s,t,a)},o)):(s.length>=3&&"US"!==S?(x=!0,i=!0):i&&(x=!1,n.toggleFieldError(t,!0)),n.refreshContinueButton())})},n.toggleFieldError=function(t,a){var i=e(t).filter(":visible").closest(".fieldset");a?i.find(".field-error").show():i.find(".field-error").hide()},n.toggleSaleTaxDetails=function(t){var a=n.getModel("plan");a.tax||(t=!1),e(".sale-tax-group").hide(),e(".sale-tax-group").find(".sale-tax-amount").html(""),e(".sale-tax-group").find(".sale-tax-full-amount").html(""),t&&(null===p||a.tax===a.discountTax?e(".sale-tax-amount").html(a.taxFormatted):("lifetime"!==n.getSelPlan()&&e(".sale-tax-full-amount").html(a.taxFormatted),e(".sale-tax-amount").html(a.discountTaxFormatted)),e(".sale-tax-group").fadeIn()),n.refreshSummary()},n.getSaleTaxForZip=function(t,a,i){i="none"!==i?i:"";var r={"X-Plex-Product":"Plex SSO","X-Plex-Token":Plex.getAuthToken(),"X-Plex-Client-Identifier":Plex.getClientIdentifier()},o="regular"===n.getModel("plan").feature?"plexpass":n.getModel("plan").feature,l={type:o,plan:a,countryCode:S,zipCode:t,discountCode:i};return e.ajax({dataType:"json",type:"GET",headers:r,url:PlexUtils.getAPIUrl()+"/api/v2/subscriptions/tax",data:l,xhrFields:{withCredentials:!0},crossDomain:!0,error:function(e){Plex.debugLog()&&console.error(e)}})},n.isDiscounted=function(){return null!=p},n.isTrial=function(){return d&&void 0!==d.deferred_start&&null!==d&&d.deferred_start},n.maybeSetTrialData=function(){if(!s){var e=moment.duration(1e3*d.deferred_start).days();s={duration:e,formattedDuration:e+(1===e?" Day":" Days")}}},n.hasPendingSubscription=function(){return void 0!==T&&T},n.hasValidPendingSubscriptionPayment=function(){return!(!n.hasPendingSubscription()||void 0!==T._reset&&T._reset)&&(void 0!==T.extraData&&void 0!==T.extraData.nonce)},n.useActiveSubscPayment=function(){if(!n.hasPendingSubscription()){var e=n.getActivePaymentService();if(e&&"braintree"!==e)return!1;var t="comped"!==Plex.getSubscriptionAuthInfo().plan&&"lifetime"!==Plex.getSubscriptionAuthInfo().plan;return(Plex.hasActivePlexPass()||Plex.Tidal.isAddOn(Plex.getActiveSubscriptionType("tidal","mode")))&&t}return n.hasValidPendingSubscriptionPayment()},n.skipPayment=function(){var e=n.getSelPlan(),t=n.getPlansActiveIndex();return null!==p&&"lifetime"==e&&p.valid[t][e]&&1==p.porcentage[t][e]||null!==d&&void 0!==d.skip_cc&&d.skip_cc},n.isFree=function(e){var t=l;return void 0===e&&(p&&(t=p),e=n.getPlanData(t,"prices")),0===parseInt(e)},n.isLimitedFreePlan=function(e,t){return!!t&&(!n.isTrial()&&"all"!==n.getPlanData(t,"duration")&&"lifetime"!==e)},n.formattedFreePrice=function(e,t){var a=l;return n.isFree(e)&&void 0!==t?t:(void 0===t&&(p&&(a=p),t=n.getPlanData(a,"formattedPrices")),t)},n.formattedPriceWithTax=function(e,t){var a=n.getPlanData(e,"prices"),i=n.getPlanData(e,"formattedPrices");if(t=t||!1,n.getModel("plan").tax&&parseInt(a)>0){var r=t?n.getModel("plan").discountTax:n.getModel("plan").tax;i="$"+(parseFloat(a)+parseFloat(r)).toFixed(2)}return i},n.setSelPlan=function(t,a){var i=e(".ppp-plans.active").find(".selected").filter(".valid-plan"),r=PlexUtils.getParam("plan"),o=y;if(a=void 0===a||a,t=void 0!==t&&t?t:r,e(".ppp-plans.active .ppp-plan").removeClass("selected"),void 0!==t&&e(".ppp-plans.active").find(".ppp-plan.ppp-"+t).filter(".valid-plan").length&&(i=e(".ppp-plans.active").find(".ppp-plan:not(.no-ppp-promo)").filter(".ppp-"+t)),i.length||(i=e(".ppp-plans.active").find(".ppp-plan:not(.no-ppp-promo)").filter(".valid-plan").first()),i.length){var l=i.find(".ppp-plan-name").val();n.setModel({plan:{name:l.trim()}}),i.addClass("selected"),a&&i.click()}y=l,e.event.trigger("planChanged",[l,o])},n.getSelPlan=function(){var e=M[0],t=n.getModel("plan").name||e;return t||n.setModel({plan:{name:e}}),t},n.isOneTimePurchasePlan=function(e){return"lifetime"===(e=e||n.getSelPlan())},n.getPlanName=function(e,t){return t=void 0!==t&&t,void 0!==L[e]&&(e=L[e],t&&void 0!==z[e]&&(e=z[e])),e[0].toUpperCase()+e.substring(1)},n.getPlanDiscountedPrice=function(e,t){return n.getPlanPrice(e,t,!0)},n.getPlanPrice=function(e,t,a){var i=l;return a=void 0!==a&&a,n.isFree()?0:(p&&a&&(i=p),n.getPlanData(i,"prices",e,t))},n.getSelPlanPrice=function(e,t){var a=l;if(t=void 0!==t&&t,n.isFree(e))return 0;p&&t&&(a=p);var e=n.getPlanData(a,"prices");return e},n.getSelPlanDiscountedPrice=function(e){return n.getSelPlanPrice(e,!0)},n.refreshContinueButton=function(t){var a=e("#btn_confirm_purchase"),i=!1;void 0!==t?i=t:"paypal"===C&&null!==h||"creditcard"===C&&g||"applepay"===C&&null!==m||n.skipPayment()||n.useActiveSubscPayment()?(i=!0,n.requiresZipCode()&&!n.isValidZipCode()&&(i=!1)):i=!1,i?(a.removeClass("disabled").removeAttr("disabled"),e(".validation-error").html("")):a.addClass("disabled").attr("disabled",!0),n.requiresZipCode()&&!n.isValidZipCode()?(i&&n.toggleFieldError("#"+C+"-postal-code",!0),n.setValidForm(!1,"Please fill in a valid zip code.")):i?n.setValidForm(i):n.setValidForm(!1)},n.getNonce=function(){var e=null;return n.skipPayment()||n.useActiveSubscPayment()?e="":f?e=f:"creditcard"===C&&null!==P?e=P.nonce:"paypal"===C&&null!==h?e=h:"applepay"===C&&null!==m&&(e=m),e},n.resetNonces=function(){n.clearPendingSubscription(),v=!0,"paypal"===C?n.unsetPaypalNonce():"applepay"===C?n.unsetApplePayNonce():C&&g||(n.unsetPaypalNonce(),n.unsetApplePayNonce())},n.setPaypalNonce=function(t,a){h=t,null!==t?(e(".ppp-purchase-action").show(),e(".paypal-email-linked").text(a)):e(".paypal-email-linked").text(""),n.refreshContinueButton(),e("#btn_paypal").hide(),e("#btn_paypal_linked").show()},n.unsetPaypalNonce=function(t){t=void 0===t||t,h=null,e(".ppp-purchase-action").hide(),e("#btn_paypal_linked").hide(),n.refreshContinueButton(),e("#btn_paypal").show(),t&&n.setValidForm(!1)},n.ApplePayPriceChangeReset=function(a,i){var r=e(".ppp-with-payment li.applepay");i=void 0!==i&&i,"applepay"!==C&&null===m||("applepay"===C&&null!==m&&t.setTimeout(function(){alert(a)},1e3),null!==m&&n.unsetApplePayNonce(),i&&r.hide().addClass("temp-hidden"))},n.setApplePayNonce=function(t){m=t,null!==t&&e(".ppp-purchase-action").show(),n.refreshContinueButton(),e("#btn_applepay").hide(),e("#btn_applepay_linked").show();var a=!1;e(document).on("trialSelected",function(e){n.ApplePayPriceChangeReset("Apple Pay cannot be used with Trial purchases. Please use other payment to continue.",!0),a=!0}),a&&null===m||e(document).on("priceChange",function(e){n.ApplePayPriceChangeReset("Prices changed. Apple Pay will require new payment authorization.")})},n.unsetApplePayNonce=function(){m=null,e(".ppp-purchase-action").hide(),e("#btn_applepay_linked").hide(),n.refreshContinueButton(),e("#btn_applepay").show()},n.setValidForm=function(t,a){void 0!==a&&null!==a||g||(a=n.isPayPalPurchase()?"We can't continue until you've authenticated with PayPal.":"We can't continue until you've completed filling in your credit card details."),g=t,g?(e(".ppp-purchase-action").show(),e("#btn_purchase").removeClass("disabled").removeAttr("disabled"),e(".validation-error").html("")):(e(".ppp-purchase-action").hide(),e("#btn_purchase").addClass("disabled").attr("disabled","true"),e(".validation-error").html(a))},n.createPaypal=function(t){var a=e("#btn_paypal"),i=e("#btn_paypal_unlink");a.unbind("click"),i.unbind("click"),i.click(n.unsetPaypalNonce),braintree.paypal.create({client:t},function(t,i){if(t)return void console.error("Error creating PayPal:",t);a.removeAttr("disabled"),n.zipCodeValidityChange("#paypal-postal-code"),e(".dd-country.pp-country").off("change").on("change",function(t){S=e(t.currentTarget).val(),e(".dd-country").val(S),e("#paypal_country_form").find(".zip").hide(),"US"===S&&e("#paypal_country_form").find(".zip").show(),e("#paypal-postal-code").trigger("keyup",!0),n.refreshPrices()}),e(document).on("planChanged",function(e,t,a){if(a&&t!==a&&h&&(n.isOneTimePurchasePlan()||n.isOneTimePurchasePlan(a))){var i=!1;n.isPayPalPurchase()&&(i=!0),n.showProcessError("",".ppp-form-error-subsc-type-plan-change"),n.unsetPaypalNonce(i)}}),a.click(function(e){n.clearProcessError();var t=n.isOneTimePurchasePlan()?"checkout":"vault";t="vault",Plex.debugLog()&&console.log("PayPal Flow Type:",t),i.tokenize({flow:t},function(e,t){if(e)return void("CUSTOMER"!==e.type&&console.error("Error tokenizing:",e));v=!1,n.setPaypalNonce(t.nonce,t.details.email)})})})},n.createApplePay=function(t){var i=e(".ppp-with-payment li.applepay"),r=e("#btn_applepay");e("#btn_applepay_unlink").click(n.unsetApplePayNonce),braintree.applePay.create({client:t},function(e,t){if(e)return void console.error("Error creating ApplePay:",e);ApplePaySession.canMakePaymentsWithActiveCard(t.merchantIdentifier).then(function(e){e&&(a=!0,i.show())}),r.removeAttr("disabled"),r.click(function(e){var a=n.getSelPlanDiscountedPrice(),i=n.getSelPlanPrice(),r=t.createPaymentRequest({total:{label:"Plex, Inc.",amount:a},lineItems:[{label:n.getSelPlan(),amount:a}]});n.isDiscounted()&&(r.lineItems.push({label:"Regular Price",amount:i}),r.lineItems.push({label:"Discount",amount:"-"+(i-a)}));var o=new ApplePaySession(2,r);o.onvalidatemerchant=function(e){t.performValidation({validationURL:e.validationURL,displayName:"Plex, Inc."},function(e,t){if(e)return console.error("Error validating merchant:",e),void o.abort();o.completeMerchantValidation(t)})},o.onpaymentauthorized=function(e){t.tokenize({flow:"vault",token:e.payment.token},function(e,t){if(e)return console.error("Error tokenizing Apple Pay:",e),void o.completePayment(ApplePaySession.STATUS_FAILURE);o.completePayment(ApplePaySession.STATUS_SUCCESS),n.setApplePayNonce(t.nonce)})},o.begin()})})},n.createHostedFields=function(a){var i={number:{selector:"#card-number",placeholder:""},cvv:{selector:"#cvv",placeholder:""},expirationDate:{selector:"#expirationDate",placeholder:"MM/YY"}};braintree.hostedFields.create({client:a,id:"cc_form",styles:{input:{"font-size":"0.95em","font-weight":"400",color:"#868C96","font-family":"Arial","-moz-box-sizing":"border-box","box-sizing":"border-box","-webkit-font-smoothing":"antialiased","font-smoothing":"antialiased","text-rendering":"optimizeLegibility","-moz-osx-font-smoothing":"grayscale"},":focus":{color:"#E5A00D"},".valid":{color:"#575B61"},".invalid":{color:"#F06464"},"::-webkit-input-placeholder":{color:"#B3BAC1"},":-moz-placeholder":{color:"#B3BAC1",opacity:"1"},"::-moz-placeholder":{color:"#B3BAC1",opacity:"1"},":-ms-input-placeholder":{color:"#B3BAC1"}},fields:i},function(a,i){if(!a){var r=e("#cc_form"),o=!1,l=!1,p=!1,s=!1,c=!0,u="",f=function(e){""!==r.find("#cc_country").val()&&o&&l&&p&&n.isValidZipCode()&&c?n.setValidForm(!0):n.setValidForm(!1,e)},g=function(){var t=!0,a=!1,r=i.getState();return!(null===d||void 0===d.skip_cc||!d.skip_cc)||(e.each(Object.keys(r.fields),function(e,i){r.fields[i].isValid?n.removeError(i):(t=!1,"number"===i?a="Invalid credit card.":"expirationMonth"===i||"expirationYear"===i?a="Invalid date.":"postalCode"===i&&(a="Invalid zip code."),n.showError(i,a))}),t)},y=function(t){var a="",i=e(".cc-icons .cc-icon, .ppp-payment-method-container .cc-icon"),r=e(".ccv"),o=n.getValidCCsforSelectedCountry();if(r.html(e(".ccv-info.ccv-info-default").html()),1===t.cards.length){var l=t.cards[0].type;switch(l){case"american-express":l="amex",r.html(e(".ccv-info.ccv-info-amex").html());break;case"master-card":l="mastercard";break;case"diners-club":l="diners"}u=l,-1===o.lastIndexOf(l)?(c=!1,a="Card type not supported in the Country selected.",n.showError(t.emittedBy,a)):(c||n.removeError(t.emittedBy),c=!0),i.addClass("cc-icon-off"),i.filter("."+l).removeClass("cc-icon-off"),i.filter(".ppp-payment-method-container .cc-icon").hide().filter(":not(.cc-icon-off)").show(),e(".ppp-payment-method-container .cc-icon-title").show()}else i.removeClass("cc-icon-off"),i.filter(".ppp-payment-method-container .cc-icon").hide(),e(".ppp-payment-method-container .cc-icon-title").hide(),u="";f()},x=function(t){var a=void 0!==t.fields?t.fields[t.emittedBy]:t.target.id,i=null;n.clearProcessError(),n.reCaptchaReset(),"creditcard-postal-code"===a&&(t.emittedBy="postalCode",a={isValid:n.isValidZipCode(),isEmpty:n.isValidZipCode()}),a.isValid?("number"===t.emittedBy&&a.isValid?(e(".ppp-selected-payment-method").html("Credit Card"),o=!0):"expirationDate"===t.emittedBy?l=!0:"postalCode"===t.emittedBy?s=!0:"cvv"===t.emittedBy&&(p=!0),n.removeError(t.emittedBy)):("number"===t.emittedBy?(e(".ppp-selected-payment-method").html("Credit Card"),i="Invalid credit card.",o=!1):"expirationDate"===t.emittedBy?(i="Invalid date.",l=!1):"postalCode"===t.emittedBy?(i="Invalid zip code.",s=!1):"cvv"===t.emittedBy&&(p=!1),a.isEmpty?n.removeError(t.emittedBy):n.showError(t.emittedBy,i)),f(i)},b=function(t,a){function r(e){return/^[a-zA-Z]*$/.test(e)}if(t.preventDefault(),void 0===a&&(a=!1),n.skipPayment())return n.showSummary();if("creditcard"==C){if(g()){var o={billingAddress:{countryCodeAlpha2:S,postalCode:n.getModel("zipCode")}},l=e("#email");if(l.val()){var p=l.closest("fieldset");if(l.on("keyup",function(){p.find(".field-error").hide()}),!function(e){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(e)}(l.val()))return p.find(".field-error").show(),!1;o.email=l.val()}var s={givenName:{el:"#givenName",validate:r},surname:{el:"#surname",validate:r},phoneNumber:"#phone",streetAddress:"#address",extendedAddress:"#extendedAddress",locality:"#locality"},d=[];if(e.each(Object.keys(s),function(t,a){var i="",r=null;if("object"==typeof s[a]?(r=e(s[a].el),r.closest("fieldset").find(".field-error").hide(),(i=r.val())&&!s[a].validate(i)&&d.push(a)):(r=e(s[a]),i=r.val()),!i)return!0;o.billingAddress[a]=i}),d.length)return e.each(d,function(t,a){e(s[a].el).closest("fieldset").find(".field-error").show()}),!1;R.model.billingAddress=o.billingAddress,void 0!==o.email&&(R.model.email=o.email),R.threeDSecure.enabled&&(e("#btn_purchase .btn-label").hide(),e("#btn_purchase .threedsecure-verified, #btn_purchase .threedsecure-failed").hide(),e("#btn_purchase .threedsecure-verify-wrapper").show(),e("#btn_purchase .threedsecure-verify").fadeIn(),e("#btn_purchase").addClass("disabled").attr("disabled","true")),i.tokenize(o,function(t,i){if(t)return void console.error(t);P=i,Plex.debugLog()&&console.log("Nonce: "+P.nonce),R.setPayload("creditcard",P),n.setValidForm(null!==n.getNonce(),"");var r=function(){R.threeDSecure.enabled&&(e("#btn_purchase .threedsecure-verify-wrapper").hide(),e("#btn_purchase .threedsecure-verified").show()),setTimeout(function(){e("#btn_purchase .btn-label").fadeIn(),e("#btn_purchase .threedsecure-verified, #btn_purchase .threedsecure-failed").hide(),n.showSummary(),a&&n.submitPurchasePrepare()},500)};R.threeDSecure.enabled?R.threeDSecure.verify().then(r).fail(function(t){e("#btn_purchase .threedsecure-failed").show(),setTimeout(function(){e("#btn_purchase .btn-label").fadeIn(),e("#btn_purchase .threedsecure-verify").hide()},1e3)}).always(function(){e("#btn_purchase .threedsecure-verify-wrapper").hide(),e("#btn_purchase").removeClass("disabled").removeAttr("disabled")}):r()})}}else("paypal"===C&&null!==h||"applepay"===C&&null!==m)&&(n.setValidForm(!0,""),n.showSummary())};e("#btn_confirm_purchase").off("click").on("click",function(e){v?function(e){b(e,!0)}(e):n.submitPurchasePrepare()}),n.zipCodeValidityChange("#creditcard-postal-code",f),e(document).on("keyup","#creditcard-postal-code",function(e){x(e)}),e(".dd-country.cc-country").off("change").on("change",function(a){S=e(this).val(),e("#creditcard-postal-code").trigger("keyup",!0),Plex.debugLog()&&(console.log("country = "+n.getSelectedCountryCode()),console.log("currency = "+n.getSelectedCurrency()),console.log("plans feature index = "+n.getPlansActiveIndex()));var i=n.getValidCCsforSelectedCountry(S);e(".dd-country").val(S),R.threeDSecure.enabled&&plex_l10n.purchase.threedsecure_country_code&&n.loadClientToken().done(function(){n.initBraintree()}).fail(function(e){n.showProcessError("threedsecure-na",null,t.location.href),console.error(e)}),""===S?n.showError("country","Please select your billing country."):""!==u&&-1===i.lastIndexOf(u)?(c=!1,n.showError("number","Card type not supported in the Country selected.")):(c||n.removeError("number"),c=!0,n.removeError("country")),n.refreshValidCardTypes(),n.refreshPrices(),"creditcard"===C&&f()}),i.on("validityChange",x),i.on("cardTypeChange",y),e("#cc_form").submit(function(e){v=!1,b(e)})}})},n.showError=function(t,a){var i="";"number"===t?i="#card-number":"expirationDate"===t?i="#expirationDate":"postalCode"===t?i="#zip-code":"country"===t&&(i="#cc_country, #paypal_country, #applepay_country");var r=e(i).parent();r.find(".field-error").html(a).show(),r.removeClass("input-field-success").addClass("input-field-error"),e(".validation-error").html(a)},n.removeError=function(t){var a="";"number"===t?a="#card-number":"expirationDate"===t?a="#expirationDate":"postalCode"===t?a="#zip-code":"country"===t&&(a="#cc_country, #paypal_country, #applepay_country");var i=e(a).parent();i.find(".field-error").html("").hide(),i.removeClass("input-field-error").addClass("input-field-success"),e(".validation-error").html("")},n.showLoading=function(t){n.hideLoading(),t=void 0===t?"purchase":t,e(".ppp-hide, .form-error").hide();var a=e(".loading");a.find(".loading-"+t).show(),a.show()},n.hideLoading=function(){e(".loading, .ppp-summary-loading").hide().find(".loading-message").hide()},n.toggleValidation=function(t,a){"show"===t?(e("#btn_purchase .btn-label").hide(),e("#btn_purchase .form-validate-wrapper").show(),e("#btn_purchase .form-validate").fadeIn(),e("#btn_purchase").addClass("disabled").attr("disabled","true")):(e("#btn_purchase .form-validate-wrapper").hide(),e("#btn_purchase .btn-label").fadeIn(),e("#btn_purchase .form-validate").hide(),n.refreshContinueButton()),void 0!==a?e("#btn_purchase").find(".verify-text").text(a):e("#btn_purchase").find(".verify-text").text(e("#btn_purchase").find(".verify-text").data("text"))},n.toggleVerify=function(t,a){"show"===t?(e("#btn_purchase .btn-label").hide(),e("#btn_purchase .threedsecure-verify-wrapper").show(),e("#btn_purchase .threedsecure-verify").fadeIn(),e("#btn_purchase").addClass("disabled").attr("disabled","true")):(e("#btn_purchase .threedsecure-verify-wrapper").hide(),e("#btn_purchase .btn-label").fadeIn(),e("#btn_purchase .threedsecure-verified, #btn_purchase .threedsecure-failed").hide(),n.setValidForm(null!==n.getNonce())),void 0!==a?e("#btn_purchase").find(".verify-text").text(a):e("#btn_purchase").find(".verify-text").text(e("#btn_purchase").find(".verify-text").data("text"))},n.loadDeviceData=function(e){braintree.dataCollector.create({client:e,kount:!0},function(e,t){if(e)return void console.error(e.message);u=t.deviceData})},n.initBraintree=function(){braintree.client.create({authorization:c},function(e,a){e&&console.error("initBraintree Error = "+e.message),R.threeDSecure.create(a),n.loadDeviceData(a),n.createHostedFields(a),n.createPaypal(a),t.ApplePaySession&&ApplePaySession.canMakePayments()&&n.createApplePay(a)})},n.isPayPalPurchase=function(){return"paypal"===C},n.isApplePayPurchase=function(){return"applepay"===C},n.isTidalCheckout=function(){return"tidal"===n.getModel("plan").feature},n.discountCodesEnabled=function(){return!n.isTidalCheckout()},n.toggleSubscriptionResultPanel=function(t,a){if(a=void 0!==a?a:"regular",e(".ppp-form").hide(),e(".ppp-plans").hide(),e(".ppp-header.active").hide(),"success"===t){e(".ppp-form-summary").hide(),e(".ppp-form-success").show(),e(".sign-frame").addClass("frame-summary");var i=e(".ppp-form-success").find(".confirmation-toggable").filter(".ppp-"+a);i.length&&(e(".ppp-form-success").find(".confirmation-toggable").filter(":not(.ppp-"+a+")").hide(),i.find(".plan-title").length&&i.find(".plan-title").html(n.getPlanName(a)),i.show())}else"error"===t?(e(".ppp-form-summary").show(),e(".ppp-header-summary").show()):e(".sign-frame").removeClass("frame-summary")},n.showProcessError=function(t,a,i){var r=void 0!==t.status?t.status:t,o=!0;a=void 0!==a&&a?a:".ppp-form-error";var l=e(a);if(n.hideLoading(),"string"==typeof r&&(r=r.trim(),/\s/.test(r)&&(o=!1)),
o&&e(".form-error").filter(".ppp-form-error-"+r).length)l=e(".form-error").filter(".ppp-form-error-"+r);else{var p="";void 0!==t.responseJSON?e.each(t.responseJSON.errors,function(e,t){p+=p?"<br/>":"",p+=t.message}):p=void 0!==t.status&&void 0!==t.statusText?t.status+": "+t.statusText:t,l.find(".error-details").html(p.replace(/ *\([^)]*\) */g,""))}i&&l.find(".btn_summary_back").attr("data-return-url",i),l.show()},n.clearProcessError=function(){e(".form-error").hide()},n.trackCheckout=function(e){var t={plan:n.getSelPlan()};PlexMetrics.track("view","checkout:"+e,{properties:t})},n}():console.log("PlexPurchase is already defined."),e(document).ready(function(){var t=e(".ppp-with-payment li.applepay");e(document).on("summaryUpdated",function(){a&&t.show()}),PlexPurchase.setValidForm(!1),e(document).on("trialSelected",function(){a&&t.hide()}),e(".ccv").html(e(".ccv-info.ccv-info-default").html()),e(".tooltip-secure").tooltipster({theme:"tooltipster-shadow",maxWidth:400,interactive:!0}),e(".tooltip-ccv").tooltipster({theme:"tooltipster-shadow",contentAsHTML:!0,functionBefore:function(t,a){t.content(e(".ccv").html())}})})}(jQuery,window);